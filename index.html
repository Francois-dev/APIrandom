<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace de Travail Personnel</title>
    <style>
        :root { --bg: #f8f9fa; --text: #333; --primary: #007bff; --white: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: var(--bg); color: var(--text); }
        #chat-box { height: 600px; overflow-y: auto; border-radius: 12px; padding: 20px; background: var(--white); margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; }
        .controls { display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 14px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        #config-area { margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; display: none; }
        .msg { padding: 12px 16px; border-radius: 15px; position: relative; max-width: 85%; line-height: 1.5; }
        .user-msg { background: #e7f3ff; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-msg { background: #f1f0f0; align-self: flex-start; border-bottom-left-radius: 2px; white-space: pre-wrap; }
        .copy-btn { font-size: 11px; padding: 4px 8px; background: #ddd; color: #555; border-radius: 4px; position: absolute; top: -25px; right: 0; opacity: 0.6; }
        .copy-btn:hover { opacity: 1; background: #ccc; }
    </style>
</head>
<body>

    <div id="config-area">
        <p>üîë <strong>Configuration :</strong> Entrez votre cl√© API Google.</p>
        <input type="password" id="api-key-input" placeholder="AIzaSy...">
        <button onclick="saveKey()">Enregistrer</button>
    </div>

    <h2>Espace de travail PRO</h2>
    <div id="chat-box" id="chatBox"></div>
    
    <div class="controls">
        <input type="text" id="user-input" placeholder="Posez votre question..." onkeypress="if(event.key === 'Enter') askGemini()">
        <button id="send-btn" onclick="askGemini()">Envoyer</button>
    </div>

    <p style="text-align: center; margin-top: 20px;">
        <button onclick="clearKey()" style="background:none; color:red; text-decoration:underline; font-size: 0.8em;">Effacer la cl√©</button>
    </p>

    <script>
        const savedKey = localStorage.getItem('gemini_api_key');
        if (!savedKey) document.getElementById('config-area').style.display = 'block';

        function saveKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) { localStorage.setItem('gemini_api_key', key); location.reload(); }
        }

        function clearKey() { localStorage.removeItem('gemini_api_key'); location.reload(); }

        async function copyText(btn, text) {
            await navigator.clipboard.writeText(text);
            const originalText = btn.innerText;
            btn.innerText = "Copi√© !";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        async function askGemini() {
            const apiKey = localStorage.getItem('gemini_api_key');
            const input = document.getElementById('user-input');
            const box = document.getElementById('chat-box');
            const btn = document.getElementById('send-btn');
            const prompt = input.value.trim();

            if (!apiKey || !prompt) return;
            
            box.innerHTML += `<div class="msg user-msg"><strong>Vous :</strong><br>${prompt}</div>`;
            input.value = '';
            btn.disabled = true;
            btn.innerText = "...";

            try {
                const workerUrl = "https://worker.francois-6fe.workers.dev";
                const response = await fetch(`${workerUrl}/v1beta/models/gemini-pro-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                
                // Cr√©ation de l'√©l√©ment message AI avec bouton copie
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg ai-msg';
                msgDiv.innerHTML = `<button class="copy-btn" onclick="copyText(this, \`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">Copier</button><strong>Gemini :</strong><br>${text}`;
                
                box.appendChild(msgDiv);
            } catch (e) {
                box.innerHTML += `<p style="color:red;">Erreur : ${e.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "Envoyer";
                box.scrollTop = box.scrollHeight;
            }
        }
    </script>
</body>
</html>
